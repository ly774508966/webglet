var gl;var App=new Class({Implements:Options,options:{name:"webglet-app",width:800,height:600,frameRate:60},initialize:function(b,a){this.setOptions(a);this.element=b;this.createCanvas();this.frameCount=0},createCanvas:function(){this.canvas=new Element("canvas",{id:this.options.name,width:this.options.width,height:this.options.height});try{gl=this.canvas.getContext("experimental-webgl");if(this.options.debug){gl=WebGLDebugUtils.makeDebugContext(gl)}gl.viewport(0,0,this.options.width,this.options.height)}catch(c){}if(gl){this.canvas.inject(this.element)}else{var e=new Element("div",{"class":"webglet-alert"});e.set("html",'<strong>WebGL not enabled</strong><br/>For instructions on how to get a WebGL enabled browser <a href="http://www.khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">click here</a>');e.inject(this.element);var a=$$("script");for(var d=0;d<a.length;d++){var g=a[d].getProperty("src");if(g){g=g.trim();var b=g.search("WebGLet.js$|WebGLet.min.js$");if(b!=-1){g=g.slice(0,b)+"images/error.png";var f=new Element("img",{src:g,style:"float: left"});f.inject(e,"top")}}}}},preDraw:function(){this.frameCount+=1;this.draw()},draw:function(){},run:function(){this.preDraw.periodical(1000/this.options.frameRate,this)},clear:function(a){gl.clearColor(a[0],a[1],a[2],a[3]);gl.clear(gl.COLOR_BUFFER_BIT)}});var Attribute=new Class({initialize:function(b,a){this.size=b.size;this.type=b.type;this.name=b.name;this.location=gl.getAttribLocation(a,this.name);this.createFunctionHashes();this.createSizeHash()},createFunctionHashes:function(){this.floatFunctions={};this.floatFunctions[gl.FLOAT]=gl.vertexAttrib1fv;this.floatFunctions[gl.FLOAT_VEC2]=gl.vertexAttrib2fv;this.floatFunctions[gl.FLOAT_VEC3]=gl.vertexAttrib3fv;this.floatFunctions[gl.FLOAT_VEC4]=gl.vertexAttrib4fv;this.matrixFunctions={};this.matrixFunctions[gl.FLOAT_MAT2]=gl.vertexAttrib2fv;this.matrixFunctions[gl.FLOAT_MAT3]=gl.vertexAttrib3fv;this.matrixFunctions[gl.FLOAT_MAT4]=gl.vertexAttrib4fv},createSizeHash:function(){this.sizes={};this.sizes[gl.FLOAT]=1;this.sizes[gl.FLOAT_VEC2]=2;this.sizes[gl.FLOAT_VEC3]=3;this.sizes[gl.FLOAT_VEC4]=4;this.sizes[gl.FLOAT_MAT2]=4;this.sizes[gl.FLOAT_MAT3]=9;this.sizes[gl.FLOAT_MAT4]=16},setValue:function(a){if(typeOf(a)=="number"){a=[a]}if(this.floatFunctions[this.type]){this.setFloat(a)}else{if(this.matrixFunctions[this.type]){this.setMatrix(a)}}},setFloat:function(a){this.floatFunctions[this.type].apply(gl,[this.location,a])},setMatrix:function(a){this.matrixFunctions[this.type].apply(gl,[this.location,a])},setPointer:function(){gl.enableVertexAttribArray(this.location);gl.vertexAttribPointer(this.location,this.sizes[this.type],gl.FLOAT,false,0,0)}});var Shader=new Class({initialize:function(c){this.name=c;var a=$(this.name);var b=a.get("type");if(b=="x-shader/x-vertex"){this.type=gl.VERTEX_SHADER}else{if(b=="x-shader/x-fragment"){this.type=gl.FRAGMENT_SHADER}}console.log("Creating %s shader %s",b,this.name);this.shader=gl.createShader(this.type);gl.shaderSource(this.shader,a.get("text"));gl.compileShader(this.shader);if(!gl.getShaderParameter(this.shader,gl.COMPILE_STATUS)){console.error("Could not compile shader ",this.name,"\n",gl.getShaderInfoLog(this.shader))}},getShader:function(){return(this.shader)}});var Uniform=new Class({initialize:function(b,a){this.size=b.size;this.type=b.type;this.name=b.name;this.location=gl.getUniformLocation(a,this.name);this.createFunctionHashes()},createFunctionHashes:function(){this.floatFunctions={};this.floatFunctions[gl.FLOAT]=gl.uniform1fv;this.floatFunctions[gl.FLOAT_VEC2]=gl.uniform2fv;this.floatFunctions[gl.FLOAT_VEC3]=gl.uniform3fv;this.floatFunctions[gl.FLOAT_VEC4]=gl.uniform4fv;this.intFunctions={};this.intFunctions[gl.INT]=gl.uniform1iv;this.intFunctions[gl.INT_VEC2]=gl.uniform2iv;this.intFunctions[gl.INT_VEC3]=gl.uniform3iv;this.intFunctions[gl.INT_VEC4]=gl.uniform4iv;this.boolFunctions={};this.boolFunctions[gl.BOOL]=gl.uniform1iv;this.boolFunctions[gl.BOOL_VEC2]=gl.uniform2iv;this.boolFunctions[gl.BOOL_VEC3]=gl.uniform3iv;this.boolFunctions[gl.BOOL_VEC4]=gl.unform4iv;this.matrixFunctions={};this.matrixFunctions[gl.FLOAT_MAT2]=gl.uniformMatrix2fv;this.matrixFunctions[gl.FLOAT_MAT3]=gl.uniformMatrix3fv;this.matrixFunctions[gl.FLOAT_MAT4]=gl.uniformMatrix4fv;this.samplerFunctions={};this.samplerFunctions[gl.SAMPLER_2D]=gl.uniform1iv;this.samplerFunctions[gl.SAMPLER_CUBE]=gl.uniform1iv},setValue:function(a){if(typeOf(a)=="number"){a=[a]}if(this.floatFunctions[this.type]){this.setFloat(a)}else{if(this.intFunctions[this.type]){this.setInt(a)}else{if(this.boolFunctions[this.type]){this.setBool(a)}else{if(this.matrixFunctions[this.type]){this.setMatrix(a)}else{if(this.samplerFunctions[this.type]){this.setSampler(a)}}}}}},setFloat:function(a){this.floatFunctions[this.type].apply(gl,[this.location,a])},setInt:function(a){this.intFunctions[this.type].apply(gl,[this.location,a])},setBool:function(a){this.boolFunctions[this.type].apply(gl,[this.location,a])},setMatrix:function(a){this.matrixFunctions[this.type].apply(gl,[this.location,false,a])},setSampler:function(a){this.samplerFunctions[this.type].apply(gl,[this.location,a])}});var ShaderProgram=new Class({initialize:function(){},program:null,shaders:{},shaderIds:[],uniforms:{},attributes:{},needRecompile:true,addShader:function(b){var a=new Shader(b);this.shaders[b]=a;this.shaderIds.push(b);this.needRecompile=true},removeShader:function(b){for(var a=0;a<this.shaderIds.length;a++){if(this.shaderIds[a]==b){delete this.shaderIds[a]}}delete this.shaders[b];this.needRecompile=true},createProgram:function(){this.program=gl.createProgram()},deleteProgram:function(){gl.deleteProgram(this.program)},attachShaders:function(){for(var a=0;a<this.shaderIds.length;a++){var b=this.shaders[this.shaderIds[a]];gl.attachShader(this.program,b.getShader())}},getAttributes:function(){var d=gl.getProgramParameter(this.program,gl.ACTIVE_ATTRIBUTES);console.log("Program %i has %i active attributes",this.program,d);for(var a=0;a<d;a++){var c=gl.getActiveAttrib(this.program,a);var b=new Attribute(c,this.program);this.attributes[b.name]=b;console.log("Attribute %i: %s",a,b.name)}},getUniforms:function(){var c=gl.getProgramParameter(this.program,gl.ACTIVE_UNIFORMS);console.log("Program %i has %i active uniforms",this.program,c);for(var b=0;b<c;b++){var d=gl.getActiveUniform(this.program,b);var a=new Uniform(d,this.program);this.uniforms[a.name]=a;console.log("Uniform %i: %s",b,a.name)}},linkProgram:function(){gl.linkProgram(this.program);if(!gl.getProgramParameter(this.program,gl.LINK_STATUS)){console.error("Could not link shader program, %i",this.program);return(false)}return(true)},useProgram:function(){gl.useProgram(this.program)},use:function(){if(this.needRecompile||ShaderProgram.activeProgram!=this.program){if(this.needRecompile){if(this.program!==null){this.deleteProgram()}this.createProgram();this.attachShaders();this.linkProgram();this.getAttributes();this.getUniforms();this.needRecompile=false}this.useProgram();ShaderProgram.activeProgram=this.program}},getUniform:function(a){return(this.uniforms[a])},setUniform:function(a,b){this.use();this.uniforms[a].setValue(b)},getAttribute:function(a){return(this.attributes[a])},setAttribute:function(a,b){this.use();this.attributes[a].setValue(b)}});ShaderProgram.activeProgram=null;var BasicRenderer=new Class({initialize:function(b,a){this.shaderProgram=new ShaderProgram();this.shaderProgram.addShader(b);this.shaderProgram.addShader(a);this.shaderProgram.use()},render:function(a){this.shaderProgram.use();a.associate(this.shaderProgram);a.render()},setUniform:function(a,b){this.shaderProgram.setUniform(a,b)}});var Buffer=new Class({initialize:function(a,c,b){this.numVertices=a;this.itemSize=c;this.usage=b;this.buffer=gl.createBuffer();this.bind();gl.bufferData(gl.ARRAY_BUFFER,a*c*4,this.usage);this.array=new Float32Array(a*c)},setValues:function(a){this.array.set(a);this.bind();gl.bufferSubData(gl.ARRAY_BUFFER,0,this.array)},bind:function(){gl.bindBuffer(gl.ARRAY_BUFFER,this.buffer)},unbind:function(){gl.bindBuffer(gl.ARRAY_BUFFER,null)},associate:function(a){this.bind();a.setPointer();this.unbind()}});var Texture=new Class({initialize:function(b,a){this.texture=gl.createTexture();this.flipped=false;this.bind();gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,b,a,0,gl.RGBA,gl.UNSIGNED_BYTE,null);this.end()},begin:function(a){if(!a){a=0}gl.activeTexture(gl.TEXTURE0+a);this.bind()},bind:function(){gl.bindTexture(gl.TEXTURE_2D,this.texture)},end:function(){gl.bindTexture(gl.TEXTURE_2D,null)},getTexture:function(){return(this.texture)},flipY:function(){if(!this.flipped){this.bind();gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true);this.end();this.flipped=true}},loadFromFile:function(a){var b=new Image();b.src=a;b.addEvent("load",function(){this.loadFromExisting(b)}.bind(this))},loadFromExisting:function(a){this.image=a;this.flipY();this.bind();gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this.image);this.end()}});Texture.prototype.load=Texture.prototype.loadFromFile;var Framebuffer=new Class({initialize:function(b,a){this.width=b;this.height=a;this.framebuffer=gl.createFramebuffer();this.begin();this.depthBuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this.depthBuffer);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,b,a);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthBuffer);gl.bindRenderbuffer(gl.RENDERBUFFER,null);this.end();this.texture=new Texture(b,a);this.attachTexture(this.texture);this.begin();if(gl.checkFramebufferStatus(gl.FRAMEBUFFER)!=gl.FRAMEBUFFER_COMPLETE){console.error("Could not create framebuffer - error ",gl.checkFramebufferStatus(gl.FRAMEBUFFER))}this.end()},begin:function(a){if(a){this.pushViewport(a)}gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffer)},end:function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);if(this.storedViewport){this.popViewport()}},attachTexture:function(a){this.texture=a;this.begin();this.texture.begin();gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.texture.getTexture(),0);this.texture.end();this.end()},clear:function(a){this.begin();gl.clearColor(a[0],a[1],a[2],a[3]);gl.clear(gl.COLOR_BUFFER_BIT);this.end()},pushViewport:function(a){this.storedViewport=a;gl.viewport(0,0,this.width,this.height)},popViewport:function(){gl.viewport(this.storedViewport[0],this.storedViewport[1],this.storedViewport[2],this.storedViewport[3]);this.storedViewport=null}});var FramebufferRenderer=new Class({Extends:BasicRenderer,initialize:function(c,a,d,b){BasicRenderer.prototype.initialize.apply(this,[d,b]);this.framebuffer=new Framebuffer(c,a)},render:function(b,a){this.shaderProgram.use();b.associate(this.shaderProgram);this.framebuffer.begin(a);b.render();this.framebuffer.end()}});var MatrixStack=new Class({initialize:function(){this.stack=[];this.matrix=mat4.create();mat4.identity(this.matrix)},pushMatrix:function(){var a=mat4.create();mat4.set(this.matrix,a);this.stack.push(a)},popMatrix:function(){if(this.stack.length>0){this.matrix=this.stack.pop()}}});var Transformation=new Class({initialize:function(){this.position=vec3.create();this.rotation=quat4.create();this.scale=vec3.create();vec3.set([1,1,1],this.scale);this.rotationMatrix=mat4.create()},apply:function(a){mat4.translate(a,this.position);quat4.toMat4(this.rotation,this.rotationMatrix);mat4.multiply(a,this.rotationMatrix);mat4.scale(a,this.scale)}});var Mesh=new Class({initialize:function(c,e,d,b,a,f){this.numVertices=c;this.drawMode=e;this.buffers={};this.createBuffer("vertex",c,3,d);if(b){this.createBuffer("color",c,4,b)}if(a){this.createBuffer("normal",c,3,a)}if(f){this.createBuffer("texCoord",c,2,f)}},createBuffer:function(a,b,d,c){this.buffers[a]=new Buffer(b,d,c);this[a+"Buffer"]=this.buffers[a]},associate:function(a){Object.each(this.buffers,function(b,e){var c="a"+e.capitalize();var d=a.getAttribute(c);if(!d){console.error("Could not associate "+c+" attribute")}b.associate(d)},this)},render:function(){gl.drawArrays(this.drawMode,0,this.numVertices)}});var RectMesh=new Class({Extends:Mesh,initialize:function(d,a,e,c,b,f){Mesh.prototype.initialize.apply(this,[4,gl.TRIANGLE_STRIP,e,c,b,f]);this.vertexBuffer.setValues([0,0,0,0,a,0,d,0,0,d,a,0]);if(f){this.texCoordBuffer.setValues([0,1,0,0,1,1,1,0])}}});