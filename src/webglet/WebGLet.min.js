var gl;var App=new Class({Implements:Options,options:{name:"webglet-app",width:800,height:600,frameRate:60,},initialize:function(b,a){this.setOptions(a);this.element=b;this.createCanvas();this.frameCount=0},createCanvas:function(){this.canvas=new Element("canvas",{id:this.options.name,width:this.options.width,height:this.options.height});try{gl=this.canvas.getContext("experimental-webgl");if(this.options.debug){gl=WebGLDebugUtils.makeDebugContext(gl)}gl.viewport(0,0,this.options.width,this.options.height)}catch(a){}if(gl){this.canvas.inject(this.element);this.canvas.addEvent("click",this.preMouseClicked.bind(this));this.canvas.addEvent("mousedown",this.preMousePressed.bind(this));this.canvas.addEvent("mouseup",this.preMouseReleased.bind(this));this.canvas.addEvent("mousemove",this.preMouseMoved.bind(this));document.addEvent("keydown",this.preKeyPressed.bind(this));document.addEvent("keyup",this.preKeyReleased.bind(this))}else{var b=new Element("div",{"class":"webglet-alert"});b.set("text","WebGL not enabled");b.inject(this.element)}},preDraw:function(){this.frameCount+=1;this.draw()},draw:function(){},run:function(){this.preDraw.periodical(1000/this.options.frameRate,this)},clear:function(a){gl.clearColor(a[0],a[1],a[2],a[3]);gl.clear(gl.COLOR_BUFFER_BIT)},preMouseClicked:function(b){var a=this.canvas.getPosition();this.mouseClicked(b.page.x-a.x,b.page.y-a.y)},mouseClicked:function(b,a){},preMousePressed:function(b){var a=this.canvas.getPosition();this.mousePressed(b.page.x-a.x,b.page.y-a.y)},mousePressed:function(b,a){},preMouseReleased:function(b){var a=this.canvas.getPosition();this.mouseReleased(b.page.x-a.x,b.page.y-a.y)},mouseReleased:function(b,a){},preMouseMoved:function(b){var a=this.canvas.getPosition();this.mouseMoved(b.page.x-a.x,b.page.y-a.y)},mouseMoved:function(b,a){},preKeyPressed:function(a){this.keyPressed(a.key)},keyPressed:function(a){},preKeyReleased:function(a){this.keyReleased(a.key)},keyReleased:function(a){}});var Attribute=new Class({initialize:function(b,a){this.size=b.size;this.type=b.type;this.name=b.name;this.location=gl.getAttribLocation(a,this.name);this.createFunctionHashes();this.createSizeHash()},createFunctionHashes:function(){this.floatFunctions={};this.floatFunctions[gl.FLOAT]=gl.attrib1fv;this.floatFunctions[gl.FLOAT_VEC2]=gl.attrib2fv;this.floatFunctions[gl.FLOAT_VEC3]=gl.attrib3fv;this.floatFunctions[gl.FLOAT_VEC4]=gl.attrib4fv;this.matrixFunctions={};this.matrixFunctions[gl.FLOAT_MAT2]=gl.attrib2fv;this.matrixFunctions[gl.FLOAT_MAT3]=gl.attrib3fv;this.matrixFunctions[gl.FLOAT_MAT4]=gl.attrib4fv},createSizeHash:function(){this.sizes={};this.sizes[gl.FLOAT]=1;this.sizes[gl.FLOAT_VEC2]=2;this.sizes[gl.FLOAT_VEC3]=3;this.sizes[gl.FLOAT_VEC4]=4;this.sizes[gl.FLOAT_MAT2]=4;this.sizes[gl.FLOAT_MAT3]=9;this.sizes[gl.FLOAT_MAT4]=16},setValue:function(a){if(this.floatFunctions[this.type]){this.setFloat(a)}else{if(this.matrixFunctions[this.type]){this.setMatrix(a)}}},setFloat:function(a){this.floatFunctions[this.type].apply(gl,[this.location,a])},setMatrix:function(a){this.matrixFunctions[this.type].apply(gl,[this.location,a])},setPointer:function(){gl.enableVertexAttribArray(this.location);gl.vertexAttribPointer(this.location,this.sizes[this.type],gl.FLOAT,false,0,0)}});var Renderer=new Class({Implements:Options,options:{},initialize:function(a){this.setOptions(a)},render:function(){}});var Shader=new Class({initialize:function(c){this.name=c;var a=$(this.name);var b=a.get("type");if(b=="x-shader/x-vertex"){this.type=gl.VERTEX_SHADER}else{if(b=="x-shader/x-fragment"){this.type=gl.FRAGMENT_SHADER}}console.log("Creating %s shader %s",b,this.name);this.shader=gl.createShader(this.type);gl.shaderSource(this.shader,a.get("text"));gl.compileShader(this.shader);if(!gl.getShaderParameter(this.shader,gl.COMPILE_STATUS)){console.error("Could not compile shader ",this.name,"\n",gl.getShaderInfoLog(this.shader))}},getShader:function(){return(this.shader)}});var Uniform=new Class({initialize:function(b,a){this.size=b.size;this.type=b.type;this.name=b.name;this.location=gl.getUniformLocation(a,this.name);this.createFunctionHashes()},createFunctionHashes:function(){this.floatFunctions={};this.floatFunctions[gl.FLOAT]=gl.uniform1fv;this.floatFunctions[gl.FLOAT_VEC2]=gl.uniform2fv;this.floatFunctions[gl.FLOAT_VEC3]=gl.uniform3fv;this.floatFunctions[gl.FLOAT_VEC4]=gl.uniform4fv;this.intFunctions={};this.intFunctions[gl.INT]=gl.uniform1iv;this.intFunctions[gl.INT_VEC2]=gl.uniform2iv;this.intFunctions[gl.INT_VEC3]=gl.uniform3iv;this.intFunctions[gl.INT_VEC4]=gl.uniform4iv;this.boolFunctions={};this.boolFunctions[gl.BOOL]=gl.uniform1iv;this.boolFunctions[gl.BOOL_VEC2]=gl.uniform2iv;this.boolFunctions[gl.BOOL_VEC3]=gl.uniform3iv;this.boolFunctions[gl.BOOL_VEC4]=gl.unform4iv;this.matrixFunctions={};this.matrixFunctions[gl.FLOAT_MAT2]=gl.uniformMatrix2fv;this.matrixFunctions[gl.FLOAT_MAT3]=gl.uniformMatrix3fv;this.matrixFunctions[gl.FLOAT_MAT4]=gl.uniformMatrix4fv;this.samplerFunctions={};this.samplerFunctions[gl.SAMPLER_2D]=gl.uniform1iv;this.samplerFunctions[gl.SAMPLER_CUBE]=gl.uniform1iv},setValue:function(a){if(this.floatFunctions[this.type]){this.setFloat(a)}else{if(this.intFunctions[this.type]){this.setInt(a)}else{if(this.boolFunctions[this.type]){this.setBool(a)}else{if(this.matrixFunctions[this.type]){this.setMatrix(a)}else{if(this.samplerFunctions[this.type]){this.setSampler(a)}}}}}},setFloat:function(a){this.floatFunctions[this.type].apply(gl,[this.location,a])},setInt:function(a){this.intFunctions[this.type].apply(gl,[this.location,a])},setBool:function(a){this.boolFunctions[this.type].apply(gl,[this.location,a])},setMatrix:function(a){this.matrixFunctions[this.type].apply(gl,[this.location,false,a])},setSampler:function(a){this.samplerFunctions[this.type].apply(gl,[this.location,a])}});var ShaderProgram=new Class({initialize:function(){},program:null,shaders:{},shaderIds:[],uniforms:{},attributes:{},needRecompile:true,addShader:function(b){var a=new Shader(b);this.shaders[b]=a;this.shaderIds.push(b);this.needRecompile=true},removeShader:function(b){for(var a=0;a<this.shaderIds.length;a++){if(this.shaderIds[a]==b){delete this.shaderIds[a]}}delete this.shaders[b];this.needRecompile=true},createProgram:function(){this.program=gl.createProgram()},deleteProgram:function(){gl.deleteProgram(this.program)},attachShaders:function(){for(var a=0;a<this.shaderIds.length;a++){var b=this.shaders[this.shaderIds[a]];gl.attachShader(this.program,b.getShader())}},getAttributes:function(){var d=gl.getProgramParameter(this.program,gl.ACTIVE_ATTRIBUTES);console.log("Program %i has %i active attributes",this.program,d);for(var a=0;a<d;a++){var c=gl.getActiveAttrib(this.program,a);var b=new Attribute(c,this.program);this.attributes[b.name]=b;console.log("Attribute %i: %s",a,b.name)}},getUniforms:function(){var c=gl.getProgramParameter(this.program,gl.ACTIVE_UNIFORMS);console.log("Program %i has %i active uniforms",this.program,c);for(var b=0;b<c;b++){var d=gl.getActiveUniform(this.program,b);var a=new Uniform(d,this.program);this.uniforms[a.name]=a;console.log("Uniform %i: %s",b,a.name)}},linkProgram:function(){gl.linkProgram(this.program);if(!gl.getProgramParameter(this.program,gl.LINK_STATUS)){console.error("Could not link shader program, %i",this.program);return(false)}return(true)},useProgram:function(){gl.useProgram(this.program)},use:function(){if(this.needRecompile){if(this.program!==null){this.deleteProgram()}this.createProgram();this.attachShaders();this.linkProgram();this.getAttributes();this.getUniforms();this.needRecompile=false}this.useProgram()},getUniform:function(a){return(this.uniforms[a])},getAttribute:function(a){return(this.attributes[a])}});var BasicRenderer=new Class({Extends:Renderer,initialize:function(c,a,b){Renderer.prototype.initialize.apply(this,[b]);this.shaderProgram=new ShaderProgram();this.shaderProgram.addShader(c);this.shaderProgram.addShader(a);this.shaderProgram.use()},render:function(a,c){this.shaderProgram.use();for(var b=0;b<a.length;b++){this.renderMesh(a[b],c)}},renderMesh:function(b,a){a.modelview.pushMatrix();b.transformation.apply(a.modelview.matrix);a.setUniforms(this.shaderProgram);a.modelview.popMatrix();b.associate(this.shaderProgram);b.render()}});var Buffer=new Class({initialize:function(a,c,b){this.numVertices=a;this.itemSize=c;this.usage=b;this.buffer=gl.createBuffer();this.bind();gl.bufferData(gl.ARRAY_BUFFER,a*c*4,this.usage)},setValues:function(a){this.bind();gl.bufferSubData(gl.ARRAY_BUFFER,0,new Float32Array(a))},bind:function(){gl.bindBuffer(gl.ARRAY_BUFFER,this.buffer)},unbind:function(){gl.bindBuffer(gl.ARRAY_BUFFER,null)},associate:function(a){this.bind();a.setPointer();this.unbind()}});var MatrixStack=new Class({initialize:function(){this.stack=[];this.matrix=mat4.create();mat4.identity(this.matrix)},pushMatrix:function(){var a=mat4.create();mat4.set(this.matrix,a);this.stack.push(a)},popMatrix:function(){if(this.stack.length>0){this.matrix=this.stack.pop()}}});var Camera=new Class({initialize:function(){this.projection=new MatrixStack();this.modelview=new MatrixStack()},perspective:function(c,b,d,a){mat4.perspective(c,b,d,a,this.projection.matrix)},ortho:function(f,c,e,b,d,a){mat4.ortho(f,c,e,b,d,a,this.projection.matrix)},lookAt:function(c,b,a){mat4.lookAt(c,b,a,this.modelview.matrix)},setUniforms:function(c){var b=c.getUniform("uProjectionMatrix");b.setValue(this.projection.matrix);var a=c.getUniform("uModelviewMatrix");a.setValue(this.modelview.matrix)}});var Texture=new Class({initialize:function(b,a){this.texture=gl.createTexture();this.bind();gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,b,a,0,gl.RGBA,gl.UNSIGNED_BYTE,null);this.end()},begin:function(a){if(!a){a=0}gl.activeTexture(gl.TEXTURE0+a);this.bind()},bind:function(){gl.bindTexture(gl.TEXTURE_2D,this.texture)},end:function(){gl.bindTexture(gl.TEXTURE_2D,null)},getTexture:function(){return(this.texture)},load:function(a){this.image=new Image();this.image.src=a;this.image.addEvent("load",function(){this.bind();gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this.image);this.end()}.bind(this));this.image.src=a}});var Framebuffer=new Class({initialize:function(b,a){this.width=b;this.height=a;this.framebuffer=gl.createFramebuffer();this.begin();this.depthBuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this.depthBuffer);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,b,a);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthBuffer);gl.bindRenderbuffer(gl.RENDERBUFFER,null);this.texture=new Texture(b,a);this.texture.begin();gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.texture.getTexture(),0);this.texture.end();if(gl.checkFramebufferStatus(gl.FRAMEBUFFER)!=gl.FRAMEBUFFER_COMPLETE){console.error("Could not create framebuffer - error ",gl.checkFramebufferStatus(gl.FRAMEBUFFER))}this.end()},begin:function(){this.pushViewport();gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffer)},end:function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);this.popViewport()},clear:function(a){this.begin();gl.clearColor(a[0],a[1],a[2],a[3]);gl.clear(gl.COLOR_BUFFER_BIT);this.end()},pushViewport:function(){this.storedViewport=gl.getParameter(gl.VIEWPORT);if(!this.storedViewport){this.storedViewport=gl.getParameter(gl.VIEWPORT_RECT)}gl.viewport(0,0,this.width,this.height)},popViewport:function(){gl.viewport(this.storedViewport[0],this.storedViewport[1],this.storedViewport[2],this.storedViewport[3])}});var FramebufferRenderer=new Class({Extends:BasicRenderer,initialize:function(d,a,e,b,c){BasicRenderer.prototype.initialize.apply(this,[e,b,c]);this.framebuffer=new Framebuffer(d,a)},renderMesh:function(b,a){a.modelview.pushMatrix();b.transformation.apply(a.modelview.matrix);a.setUniforms(this.shaderProgram);a.modelview.popMatrix();b.associate(this.shaderProgram);this.framebuffer.begin();b.render();this.framebuffer.end()}});var PointRendererMixin=new Class({getPointSizeUniforms:function(a){this.pointSizeUniform=a.getUniform("uPointSize");this.constantAttenuationUniform=a.getUniform("uConstantAttenuation");this.linearAttenuationUniform=a.getUniform("uLinearAttenuation");this.quadraticAttenuationUniform=a.getUniform("uQuadraticAttenuation");this.minPointSizeUniform=a.getUniform("uMinPointSize");this.maxPointSizeUniform=a.getUniform("uMaxPointSize")},setPointSizeUniforms:function(a){this.pointSizeUniform.setValue([a.pointSize]);this.constantAttenuationUniform.setValue([a.constantAttenuation]);this.linearAttenuationUniform.setValue([a.linearAttenuation]);this.quadraticAttenuationUniform.setValue([a.quadraticAttenuation]);this.minPointSizeUniform.setValue([a.minPointSize]);this.maxPointSizeUniform.setValue([a.maxPointSize])}});var FramebufferPointRenderer=new Class({Extends:FramebufferRenderer,Implements:PointRendererMixin,initialize:function(e,a,d,f,b,c){FramebufferRenderer.prototype.initialize.apply(this,[e,a,f,b,c]);this.pointParams=d;this.getPointSizeUniforms(this.shaderProgram)},renderMesh:function(b,a){a.modelview.pushMatrix();b.transformation.apply(a.modelview.matrix);a.setUniforms(this.shaderProgram);a.modelview.popMatrix();this.setPointSizeUniforms(this.pointParams);b.associate(this.shaderProgram);this.framebuffer.begin();b.render();this.framebuffer.end()}});var Transformation=new Class({initialize:function(){this.position=vec3.create();this.rotation=quat4.create();this.scale=vec3.create();vec3.set([1,1,1],this.scale);this.rotationMatrix=mat4.create()},apply:function(a){mat4.translate(a,this.position);quat4.toMat4(this.rotation,this.rotationMatrix);mat4.multiply(a,this.rotationMatrix);mat4.scale(a,this.scale)}});var Mesh=new Class({initialize:function(c,e,d,b,a,f){this.numVertices=c;this.drawMode=e;this.vertexUsage=d;this.colorUsage=b;this.normalUsage=a;this.texCoordUsage=f;this.vertexBuffer=new Buffer(c,3,this.vertexUsage);if(this.colorUsage){this.colorBuffer=new Buffer(c,4,this.colorUsage)}if(this.normalUsage){this.normalBuffer=new Buffer(c,3,this.normalUsage)}if(this.texCoordUsage){this.texCoordBuffer=new Buffer(c,2,this.texCoordUsage)}this.transformation=new Transformation()},associate:function(e){var a=e.getAttribute("aVertex");if(!a){console.error("Could not associate vertex attribute")}this.vertexBuffer.associate(a);if(this.colorUsage){var c=e.getAttribute("aColor");if(!c){console.error("Could not associate color attribute")}this.colorBuffer.associate(c)}if(this.normalUsage){var b=e.getAttribute("aNormal");if(!b){console.error("Could not associate normal attribute")}this.normalBuffer.associate(b)}if(this.texCoordUsage){var d=e.getAttribute("aTexCoord");if(!d){console.error("Could not associate texCoord attribute")}this.texCoordBuffer.associate(d)}},render:function(){gl.drawArrays(this.drawMode,0,this.numVertices)}});var PointRenderer=new Class({Extends:BasicRenderer,Implements:PointRendererMixin,initialize:function(c,d,a,b){BasicRenderer.prototype.initialize.apply(this,[d,a,b]);this.pointParams=c;this.getPointSizeUniforms(this.shaderProgram)},renderMesh:function(b,a){a.modelview.pushMatrix();b.transformation.apply(a.modelview.matrix);a.setUniforms(this.shaderProgram);a.modelview.popMatrix();this.setPointSizeUniforms(this.pointParams);b.associate(this.shaderProgram);b.render()}});var RectMesh=new Class({Extends:Mesh,initialize:function(d,a,e,c,b,f){Mesh.prototype.initialize.apply(this,[4,gl.TRIANGLE_STRIP,e,c,b,f]);this.vertexBuffer.setValues([0,0,0,0,a,0,d,0,0,d,a,0]);if(this.texCoordUsage){this.texCoordBuffer.setValues([0,1,0,0,1,1,1,0])}}});